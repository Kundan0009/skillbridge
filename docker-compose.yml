services:
  mongodb:
    image: mongo:6.0
    container_name: skillbridge-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=skillbridge
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-admin123}
    volumes:
      - mongodb_data:/data/db
      - ./server/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    restart: unless-stopped
    networks:
      - skillbridge-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3

  skillbridge-backend:
    build: 
      context: ./server
      dockerfile: Dockerfile
    container_name: skillbridge-backend
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=development
      - MONGO_URI=mongodb://admin:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/skillbridge?authSource=admin
      - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyAwRubBnj2hvUgPhvqLACIuIMRe1yL_NAs}
      - JWT_SECRET=${JWT_SECRET:-sk8f9j2k3l4m5n6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z3}
      - CLIENT_URL=http://localhost:4000
      - PORT=5000
    volumes:
      - ./server/uploads:/app/uploads
      - ./server/logs:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - skillbridge-network

  skillbridge-frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: skillbridge-frontend
    ports:
      - "4000:80"
    environment:
      - REACT_APP_API_URL=http://skillbridge-backend:5000
    depends_on:
      - skillbridge-backend
    restart: unless-stopped
    networks:
      - skillbridge-network

networks:
  skillbridge-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  mongodb_data:
    driver: local